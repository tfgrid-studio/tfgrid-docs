# TFGrid Gitea Guide

Self-hosted Git service with web interface - perfect for AI agent repositories and team collaboration.

## Overview

**TFGrid Gitea** (v0.1.0) provides a lightweight, self-hosted Git service similar to GitHub but running on your ThreeFold Grid infrastructure. Ideal for storing code generated by tfgrid-ai-agent, private repositories, and team collaboration.

**Status:** ‚úÖ Production Ready

## Features

- üîí **Self-hosted** - Your code, your infrastructure, full control
- üåê **Web Interface** - GitHub-like UI for browsing repos and managing projects
- üîë **User Management** - Multiple users, organizations, and teams
- üìù **Issues & PRs** - Built-in issue tracking and pull requests
- üîó **API Access** - Full RESTful API for automation
- ü™∂ **Lightweight** - Runs efficiently on 2 cores, 4GB RAM
- üîê **Secure** - Keep your code private on decentralized infrastructure
- ‚ö° **Auto-configured** - Admin user created automatically during deployment
- üåç **Dual Network** - Access via WireGuard (private) or Mycelium (P2P)

## Quick Deployment

### Option 1: Standalone Deployment

```bash
# Deploy Gitea on single VM
tfgrid-compose up tfgrid-gitea

# Get access URLs and credentials
tfgrid-compose launch tfgrid-gitea

# Access displayed URLs automatically:
# üîó WireGuard:  http://10.1.3.2:3000
# üîó Mycelium:   http://[ipv6:address]:3000
```

**What happens during deployment:**
1. ‚úÖ VM provisioned on ThreeFold Grid
2. ‚úÖ WireGuard & Mycelium networking configured
3. ‚úÖ Gitea 1.24.6 installed
4. ‚úÖ SQLite database initialized
5. ‚úÖ Admin user `gitadmin` created automatically
6. ‚úÖ Service started and verified
7. ‚úÖ Environment variables set for easy access

**Total deployment time:** ~2-3 minutes

### Option 2: With Gateway (Recommended)

Deploy Gitea behind a gateway for SSL and custom domain:

```bash
# Deploy with gateway pattern
tfgrid-compose up tfgrid-gitea --pattern gateway --domain example.com

# Select and configure
tfgrid-compose select tfgrid-gitea
tfgrid-compose init
tfgrid-compose launch

# Access at: https://example.com/gitea
```

### Option 3: Full AI Dev Stack

Deploy AI agent + Gateway + Gitea together:

```bash
# Complete integrated workflow
tfgrid-compose up tfgrid-ai-stack --domain example.com

# Access:
# - example.com/gitea ‚Üí Gitea UI
# - example.com/website1 ‚Üí AI-generated sites
```

## Default Credentials

**Admin user automatically created during deployment:**

- **Username:** `gitadmin`
- **Password:** `changeme123`
- **Email:** `admin@localhost`

**‚ö†Ô∏è CRITICAL SECURITY:** Change the password immediately after first login!

### Custom Admin Credentials

Set environment variables **before** deployment:

```bash
export GITEA_ADMIN_USER=myadmin
export GITEA_ADMIN_PASSWORD=SecurePass123!
export GITEA_ADMIN_EMAIL=admin@example.com

tfgrid-compose up tfgrid-gitea
```

### Changing Admin Password

**Via Web Interface:**
1. Login to Gitea
2. Click your avatar (top right) ‚Üí Settings
3. Account ‚Üí Change Password
4. Enter old password and new password
5. Save changes

**Via CLI:**
```bash
tfgrid-compose ssh tfgrid-gitea
sudo -u gitea /usr/local/bin/gitea admin user change-password \
  --username gitadmin \
  --password YourNewPassword \
  --config /etc/gitea/app.ini
```

## Using with AI Agent

Perfect companion for tfgrid-ai-agent - automatically store generated code in Gitea:

### Enhanced Repository Management

Use the new app-specific commands for easy repository management:

```bash
# Select Gitea app for shorter commands
tfgrid-compose select tfgrid-gitea

# Create repositories easily
tfgrid-compose create-repo my-website --description "AI-generated website"
tfgrid-compose create-repo api-backend --private --description "Backend API"

# List all repositories
tfgrid-compose list-repos

# Clone repositories
tfgrid-compose clone-repo my-website

# Push code from AI agent
tfgrid-compose push-code my-website /path/to/ai/generated/code
```

### Setup Git Remote (Manual)

```bash
# SSH to AI agent VM
tfgrid-compose ssh tfgrid-ai-stack --vm ai-agent

# Configure git
git config --global user.name "AI Agent"
git config --global user.email "ai@example.com"

# Create and push project
cd /home/developer/code
mkdir my-website && cd my-website
git init
git remote add origin http://example.com/gitea/gitadmin/my-website.git
git add .
git commit -m "Initial commit"
git push -u origin main
```

### Automated Workflow

Coming in v0.11.0 - AI agent automatically:
1. Creates code
2. Pushes to Gitea (example.com/gitea/repos/projectname)
3. Deploys to gateway (example.com/projectname)
4. Complete visibility of all changes

## API Usage

Gitea provides a full RESTful API for automation:

### Generate API Token

1. Login to Gitea
2. Settings ‚Üí Applications
3. Generate New Token
4. Copy token (shown only once!)

### API Examples

```bash
# Create repository
curl -X POST "http://example.com/gitea/api/v1/user/repos" \
  -H "Authorization: token YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"new-repo","description":"My new repository","private":false}'

# List repositories
curl "http://example.com/gitea/api/v1/user/repos" \
  -H "Authorization: token YOUR_TOKEN"

# Get repository info
curl "http://example.com/gitea/api/v1/repos/gitadmin/my-repo" \
  -H "Authorization: token YOUR_TOKEN"

# Create issue
curl -X POST "http://example.com/gitea/api/v1/repos/gitadmin/my-repo/issues" \
  -H "Authorization: token YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title":"Bug found","body":"Description of the bug"}'
```

Full API docs available at: `http://your-gitea/api/swagger`

## Configuration

### Automatic Configuration

Gitea is pre-configured during deployment with:

- ‚úÖ SQLite database (no external DB needed)
- ‚úÖ HTTP server on port 3000
- ‚úÖ Admin user created automatically
- ‚úÖ Registration enabled (first user after admin becomes regular user)
- ‚úÖ ROOT_URL auto-detected from available IPs
- ‚úÖ Secure secrets generated automatically

### Environment Variables

TFGrid environment variables are automatically available in Gitea scripts:

```bash
# Access from any Gitea script
echo $TFGRID_APP_NAME        # "tfgrid-gitea"
echo $TFGRID_WIREGUARD_IP    # "10.1.3.2"
echo $TFGRID_MYCELIUM_IP     # "ipv6:address"
echo $TFGRID_VM_IP           # Primary IP
```

### Custom Admin User

Set before deployment to override defaults:

```bash
export GITEA_ADMIN_USER=myadmin
export GITEA_ADMIN_PASSWORD=SecurePass123!
export GITEA_ADMIN_EMAIL=admin@example.com

tfgrid-compose up tfgrid-gitea
```

### Resource Requirements

**Minimum:**

- 2 CPU cores
- 2 GB RAM
- 25 GB disk

**Recommended:**

- 2 CPU cores
- 4 GB RAM
- 50 GB disk (for multiple large repos)

## Gateway Integration

When deployed with the gateway pattern, Gitea is automatically proxied:

```nginx
# Gateway automatically configures nginx:
location /gitea/ {
    proxy_pass http://gitea-vm:3000/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

**Benefits:**

- SSL/TLS encryption via Let's Encrypt
- Custom domain support
- No port specification needed
- Professional URL: `https://example.com/gitea`

## User Management

### Creating Users

**Via tfgrid-compose commands (Recommended):**
```bash
# Select Gitea app first
tfgrid-compose select tfgrid-gitea

# Create regular user
tfgrid-compose create-user developer dev@example.com

# Create admin user
tfgrid-compose create-user admin admin@example.com --admin

# List all users
tfgrid-compose list-users

# Reset password
tfgrid-compose reset-password developer
```

**Via Web UI:**
1. Login as admin
2. Site Administration ‚Üí User Accounts
3. Create New Account
4. Fill in details and save

**Via CLI (Legacy):**
```bash
# SSH to Gitea VM
tfgrid-compose ssh tfgrid-gitea

# Create user
su - git -c "gitea admin user create \
  --username newuser \
  --password secretpass \
  --email user@example.com \
  --config /etc/gitea/app.ini"
```

### Organizations

1. Click + icon ‚Üí New Organization
2. Fill in organization details
3. Add members and set permissions
4. Create repos under organization

## Backup & Restore

### Enhanced Backup Commands

```bash
# Select Gitea app
tfgrid-compose select tfgrid-gitea

# Create backup with timestamp
tfgrid-compose backup

# Create named backup
tfgrid-compose backup my-backup-2025

# List available backups
tfgrid-compose exec ls -la /opt/gitea/backups/
```

### Manual Backup

```bash
# SSH to Gitea VM
tfgrid-compose ssh tfgrid-gitea

# Create backup
sudo tar -czf /tmp/gitea-backup-$(date +%Y%m%d).tar.gz \
  /var/lib/gitea/data \
  /etc/gitea

# Download backup
exit
scp root@<gitea-ip>:/tmp/gitea-backup-*.tar.gz ./
```

### Restore

```bash
# Upload backup to new VM
scp gitea-backup-*.tar.gz root@<new-gitea-ip>:/tmp/

# Restore using command
tfgrid-compose restore tfgrid-gitea /tmp/gitea-backup-20251021.tar.gz

# Or manually:
tfgrid-compose ssh tfgrid-gitea

# Stop service
sudo systemctl stop gitea

# Restore
sudo tar -xzf /tmp/gitea-backup-*.tar.gz -C /

# Fix permissions
sudo chown -R git:git /var/lib/gitea
sudo chown -R git:git /etc/gitea

# Start service
sudo systemctl start gitea
```

## Troubleshooting

### Service Not Starting

```bash
# Check service status
systemctl status gitea

# View logs
journalctl -u gitea -f

# Check configuration
sudo -u git /usr/local/bin/gitea doctor --config /etc/gitea/app.ini

# Restart service
systemctl restart gitea
```

### Can't Access Web Interface

```bash
# Check if port is listening
netstat -tuln | grep 3000

# Test local connection
curl http://localhost:3000

# Check firewall (if using standalone)
ufw status
ufw allow 3000/tcp
```

### Database Issues

```bash
# Check database file
ls -lh /var/lib/gitea/data/gitea.db

# Check permissions
ls -ld /var/lib/gitea/data
# Should be owned by git:git

# Repair if needed
sudo -u git sqlite3 /var/lib/gitea/data/gitea.db "PRAGMA integrity_check;"
```

### Performance Issues

**For large repositories:**

1. Increase resources in tfgrid-compose.yaml:
```yaml
resources:
  cpu: 4
  memory: 8192
  disk: 100
```

2. Redeploy:
```bash
tfgrid-compose down tfgrid-gitea
tfgrid-compose up tfgrid-gitea
```

## Security Best Practices

### Essential Security Steps

1. **Change default password** immediately
2. **Enable 2FA** (Settings ‚Üí Security ‚Üí Two-Factor Authentication)
3. **Use strong passwords** for all accounts
4. **Disable registration** if not needed (app.ini: `DISABLE_REGISTRATION = true`)
5. **Regular backups** of /var/lib/gitea/data
6. **Keep updated** - monitor Gitea releases

### SSL/TLS

Always deploy behind a gateway with SSL in production:

```bash
tfgrid-compose up tfgrid-gitea --pattern gateway --domain example.com
```

This provides:
- ‚úÖ Free Let's Encrypt SSL certificates
- ‚úÖ Automatic HTTPS redirect
- ‚úÖ Certificate auto-renewal

## Advanced Usage

### Webhooks

Configure webhooks to trigger actions on push:

1. Repository ‚Üí Settings ‚Üí Webhooks
2. Add Webhook
3. Set URL (e.g., https://example.com/deploy-hook)
4. Select events (push, pull request, etc.)
5. Save

**Use case:** Auto-deploy to gateway when AI agent pushes code.

### Git LFS

For large files (>100MB):

```bash
# Install git-lfs on client
git lfs install

# Track large files
git lfs track "*.psd"
git lfs track "*.zip"

# Commit and push as normal
git add .
git commit -m "Add large files"
git push
```

### Mirror Repositories

Mirror external repos to Gitea:

1. New Migration ‚Üí GitHub/GitLab/etc.
2. Enter source URL
3. Configure mirror settings
4. Gitea will sync automatically

## App-Specific Commands

tfgrid-gitea provides command-line management through tfgrid-compose. Commands defined in the manifest but not all are implemented yet.

### Launch & Access (‚úÖ Fully Implemented)
```bash
# Get access URLs with automatic IP detection
tfgrid-compose launch tfgrid-gitea

# Output shows:
# üîó WireGuard:  http://10.1.3.2:3000
# üîó Mycelium:   http://[ipv6:addr]:3000
# üîë Default login: gitadmin / changeme123
```

**Features:**

- ‚úÖ Automatically sources TFGrid environment variables
- ‚úÖ Detects WireGuard IP from system or environment
- ‚úÖ Detects Mycelium IPv6 address
- ‚úÖ Falls back to interface detection if vars not set
- ‚úÖ Shows default credentials

### Status Monitoring (‚úÖ Implemented)
```bash
# Check deployment status
tfgrid-compose status tfgrid-gitea

# SSH access
tfgrid-compose ssh tfgrid-gitea

# View logs
tfgrid-compose logs tfgrid-gitea
```

### Repository Management
```bash
# Use Gitea web UI or API for repository management
# SSH to VM for CLI access:
tfgrid-compose ssh tfgrid-gitea

# Create repo via Gitea CLI
sudo -u git gitea admin repo create --owner gitadmin --name my-project
```

### User Management
```bash
# SSH and use Gitea CLI
tfgrid-compose ssh tfgrid-gitea

# Create user
sudo -u git gitea admin user create \
  --username newuser \
  --email user@example.com \
  --password userpass \
  --config /etc/gitea/app.ini

# List users
sudo -u git gitea admin user list --config /etc/gitea/app.ini
```

### Backup & Restore
```bash
# Create backup
tfgrid-compose ssh tfgrid-gitea
sudo tar -czf /tmp/gitea-backup-$(date +%Y%m%d).tar.gz /var/lib/gitea /etc/gitea

# Download backup locally
exit
scp root@<gitea-ip>:/tmp/gitea-backup-*.tar.gz ./
```

## Next Steps

- **[AI Agent Guide](tfgrid-ai-agent.md)** - Use AI agent with Gitea
- **[Gateway Pattern](../patterns/gateway.md)** - Deploy with SSL
- **[App Registry](tfgrid-registry.md)** - Explore more apps
- **[Gitea Official Docs](https://docs.gitea.com/)** - Full Gitea documentation

## Support

- **TFGrid Docs:** https://docs.tfgrid.studio
- **Gitea Docs:** https://docs.gitea.com
- **GitHub Issues:** https://github.com/tfgrid-studio/tfgrid-gitea/issues
- **Discussions:** https://github.com/orgs/tfgrid-studio/discussions

---

**Made with üî• for decentralized development**
